---
title: "SEAGRASS COVERAGE DASHBOARD"
output: 
  flexdashboard::flex_dashboard:
     logo: www/tarponlogo.png
     social: menu
     source_code: "https://github.com/tbep-tech/seagrass-dash"
     includes:
       in_header: cssloaders_in_header.html
runtime: shiny
css: styles.css
---

```{r setup, include=F}
knitr::opts_chunk$set(echo = F, message = F, warning = F)

library(flexdashboard)
library(tidyverse)
library(mapedit)
library(leaflet.extras)
library(sf)
library(mapview)
library(reactable)
library(shinydashboard)
library(shinyWidgets)
library(units)
library(plotly)
library(extrafont)
library(shinycssloaders)

# # style file
# styles <- readLines('https://raw.githubusercontent.com/tbep-tech/css-styling/master/styles.css')
# writeLines(styles, 'styles.css')

loadfonts(device = 'pdf', quiet = T)
if(Sys.info()[1] == 'Windows')
  loadfonts(device = 'win', quiet = T)

fml <- "Lato Light"

flcat <- list(
  code = c('7210', '9113', '9116', '9121'),
  name = c('sand', 'patchy', 'continuous', 'attached algae')
)

data(sgdat1988)
data(sgdat1990)
data(sgdat1992)
data(sgdat1994)
data(sgdat1996)
data(sgdat1999)
data(sgdat2001)
data(sgdat2004)
data(sgdat2006)
data(sgdat2008)
data(sgdat2010)
data(sgdat2012)
data(sgdat2014)
data(sgdat2016)
data(sgdat2018)

prj <- 4326

allsg <- list(
    `1988` = sgdat1988,
    `1990` = sgdat1990,
    `1992` = sgdat1992,
    `1994` = sgdat1994,
    `1996` = sgdat1996, 
    `1999` = sgdat1999, 
    `2001` = sgdat2001, 
    `2004` = sgdat2004,
    `2006` = sgdat2006,
    `2008` = sgdat2008,
    `2010` = sgdat2010, 
    `2012` = sgdat2012, 
    `2014` = sgdat2014, 
    `2016` = sgdat2016, 
    `2018` = sgdat2018
  ) %>% 
  enframe('yr', 'data') %>% 
  mutate(
    data = purrr::map(data, function(x){
      
      x <- x %>% 
        mutate(
          FLUCCS_CODE = factor(FLUCCS_CODE, levels = flcat$code, labels = flcat$name)
        ) %>% 
        select(OBJECTID, Category = FLUCCS_CODE)
  
        
      st_crs(x) <- prj
      
      return(x) 
      
    })
  )
```

```{r reactives}
# filter all seagrass data by fluccs code
fltallsg <- reactive({
  
  # input  
  flsel <- input$flsel

  out <- allsg %>% 
    mutate(
      data = purrr::map(data, function(x){
        
        x %>% 
          filter(Category %in% flsel) %>% 
          mutate(Category = fct_drop(Category))
        
      })
    )

  return(out)
  
})

# year to plot
sgdat <- reactive({
  
  # input
  yrsel <- input$yrsel
  fltallsg <- fltallsg()
  
  out <- fltallsg %>% 
    filter(yr %in% yrsel) %>% 
    pull(data) %>% 
    .[[1]]

  validate(
    need(nrow(out) > 0, 'No selection')
  )
  
  return(out)
  
})

# overview map
allmap <- reactive({
  
  # input
  sgdat <- sgdat()
  
  # fix colors based on selection
  colreg <- c('tan', 'green', 'darkgreen', 'dodgerblue')
  names(colreg) <- c('sand', 'patchy', 'continuous', 'attached algae')
  colreg <- colreg[levels(sgdat$Category)]
  
  out <- mapview(sgdat, homebutton = F, zcol = 'Category', layer.name = 'Category', col.regions = colreg, color = 'grey', lwd = 0) %>% 
    .@map

  return(out)
  
})

# reactive edits module for map selection
edits <- reactive({
  
  # input
  allmap <- allmap()
  
  # this modifies available options in map selection toolber
  tomap <- allmap %>% 
    addDrawToolbar(
      polylineOptions = FALSE,
      circleOptions = FALSE,
      circleMarkerOptions = FALSE,
      markerOptions = FALSE,
      editOptions = editToolbarOptions()#,
      # singleFeature = TRUE
    )
  
  out <- callModule(editMod, 'editor', tomap)
  
  return(out)
  
})

# selection from map as sf object, same crs as biodat
mapsel <- reactive({

  # input
  fltallsg <- fltallsg()
  edits <- edits()()
  
  # # requires edits to continue
  # req(!is.null(edits$finished))

  # requires edits to continue  
  validate(
    need(!is.null(edits$finished), 'Make a selection from the map using the draw features')
  )
  
  # get selection, calculate area
  tocrp <- edits$finished 

  # check area of selection and validate
  chkarea <- st_area(tocrp) %>% 
    set_units('acres') %>% 
    as.numeric
  
  validate(
    need(chkarea > 1, 'Selected less than 1 acre, please select a larger area')
  )
  
  # crop and summarize by year
  out <- fltallsg %>% 
    mutate(
      data = purrr::map(data, function(x){

        x <- st_intersection(tocrp, x) %>% 
          mutate(
            area = st_area(.)
          ) %>% 
          st_set_geometry(NULL) 
        
        return(x) 
        
      })
    ) %>% 
    unnest('data') %>% 
    group_by(yr, Category) %>% 
    summarise(Acres = sum(area)) %>% 
    ungroup %>% 
    mutate(Acres = set_units(Acres, 'acres'))

  req(nrow(out) > 0)
  
  return(out)

})

# table selection
seltab <- reactive({
  
  # input
  mapsel <- mapsel()
  
  totab <- mapsel %>% 
    mutate(Acres = as.numeric(Acres)) %>% 
    spread(Category, Acres, fill = 0) %>% 
    mutate(Total = continuous + patchy)
  
  out <- reactable(totab, 
      columns = list(
        yr = colDef(name = 'Year'), 
        Total = colDef(name = 'Total (acres)')
      ), 
      defaultColDef = colDef(
        footerStyle = list(fontWeight = "bold"),
        format = colFormat(digits = 0, separators = TRUE),
        resizable = TRUE
      ),
     filterable = T, 
     defaultPageSize = 15
    )
  
  return(out)
  
})

# plot selection
selplo <- reactive({
  
  # input
  mapsel <- mapsel()

  toplo <- mapsel %>% 
    mutate(
      Acres = as.numeric(Acres)
    )
  
  cols <- c('tan', 'darkgreen', 'green', 'dodgerblue')
  names(cols) <- c('sand', 'continuous', 'patchy', 'attached algae')
  
  p <- plot_ly(toplo, x = ~yr, y= ~Acres, color = ~Category, text = ~paste0(yr, ', ', Category, ', ', round(Acres, 0), ' acres'), 
               hoverinfo = 'text',  colors = cols, alpha = 0.7) %>% 
    add_bars() %>% 
    layout(
      yaxis = list(title = 'Acres', gridcolor = '#ECECEC'),
      xaxis = list(title = ''),
      legend = list(x = 0, y = 1.1),
      barmode = 'stack',
      showlegend = T, 
      font = list(family = fml), 
      plot_bgcolor = '#FFFFFF'
    )
  # 
  # p <- ggplot(toplo, aes(x = factor(yr), y = Acres, fill = Category)) + 
  #   geom_bar(stat = 'identity') + 
  #   scale_fill_manual(values = c('green', 'darkgreen')) +
  #   theme_minimal() + 
  #   theme(
  #     axis.title.x = element_blank()
  #   )
  
  return(p)
  
})

```

MAP SUMMARY
===========================================================

Column {data-width=250}
-----------------------------------------------------------------------

```{r}
# selection editor
editModUI('editor') %>% withSpinner()
```

Column {.tabset .tabset-fade}
-----------------------------------------------------------------------

```{r}
column(12, 
  inputPanel(
    selectInput('yrsel', 'Select year on map:', choices = allsg$yr, selected = '2018'),
    pickerInput('flsel', 'Select categories:', choices = flcat$name, 
                          selected = flcat$name, multiple = T,
                          options = list("style-base" = "form-control", style = "", `actions-box` = TRUE))
))
```

### PLOT

```{r}
output$selplo <- renderPlotly(selplo())
plotlyOutput('selplo')
```

### TABULAR

```{r}
output$seltab <- renderReactable(seltab())
reactableOutput('seltab')
```

