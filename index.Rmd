---
title: "SEAGRASS COVERAGE DASHBOARD"
output: 
  flexdashboard::flex_dashboard:
     logo: www/tarponlogo.png
     social: menu
     source_code: "https://github.com/tbep-tech/seagrass-dash"
     includes:
       in_header: cssloaders_in_header.html
runtime: shiny
css: styles.css
---

```{r setup, include=F}
knitr::opts_chunk$set(echo = F, message = F, warning = F)

library(flexdashboard)
library(tidyverse)
library(mapedit)
library(leaflet.extras)
library(sf)
library(mapview)
library(reactable)
library(shinydashboard)
library(shinyWidgets)
library(units)
library(plotly)
library(extrafont)
library(shinycssloaders)
library(networkD3)

source('R/funcs.R')

# # style file
# styles <- readLines('https://raw.githubusercontent.com/tbep-tech/css-styling/master/styles.css')
# writeLines(styles, 'styles.css')

loadfonts(device = 'pdf', quiet = T)
if(Sys.info()[1] == 'Windows')
  loadfonts(device = 'win', quiet = T)

fml <- "Lato Light"

flcat <- list(
  code = c('7210', '9116', '9113', '9121'),
  name = c('sand', 'cont.', 'patchy', 'algae')
)

data(chgdat)

data(sgdat1988)
data(sgdat1990)
data(sgdat1992)
data(sgdat1994)
data(sgdat1996)
data(sgdat1999)
data(sgdat2001)
data(sgdat2004)
data(sgdat2006)
data(sgdat2008)
data(sgdat2010)
data(sgdat2012)
data(sgdat2014)
data(sgdat2016)
data(sgdat2018)

prj <- 4326

allsg <- list(
    `1988` = sgdat1988,
    `1990` = sgdat1990,
    `1992` = sgdat1992,
    `1994` = sgdat1994,
    `1996` = sgdat1996,
    `1999` = sgdat1999,
    `2001` = sgdat2001,
    `2004` = sgdat2004,
    `2006` = sgdat2006,
    `2008` = sgdat2008,
    `2010` = sgdat2010,
    `2012` = sgdat2012,
    `2014` = sgdat2014,
    `2016` = sgdat2016,
    `2018` = sgdat2018
  ) %>%
  enframe('yr', 'data') %>%
  mutate(
    data = purrr::map(data, function(x){

      x <- x %>%
        mutate(
          FLUCCS_CODE = factor(FLUCCS_CODE, levels = flcat$code, labels = flcat$name)
        ) %>%
        select(OBJECTID, Category = FLUCCS_CODE)


      st_crs(x) <- prj

      return(x)

    })
  )

# cols <- c('tan', 'darkgreen', 'green', 'brown')
cols <- c('#D2B48C', '#006400', '#00FF00', '#A52A2A')
names(cols) <- c('sand', 'cont.', 'patchy', 'algae')
```

```{r reactives}
# filter all seagrass data by fluccs code
fltallsg <- reactive({

  # input
  flsel <- input$flsel

  out <- allsg %>%
    mutate(
      data = purrr::map(data, function(x){

        x %>%
          filter(Category %in% flsel) %>%
          mutate(Category = fct_drop(Category))

      })
    )

  return(out)

})

# year to plot
sgdat <- reactive({

  # input
  yrsel <- input$yrsel
  fltallsg <- fltallsg()

  out <- fltallsg %>%
    filter(yr %in% yrsel) %>%
    pull(data) %>%
    .[[1]]

  validate(
    need(nrow(out) > 0, 'No selection')
  )

  return(out)

})

# overview map, shows only simplified polygons
allmap <- reactive({

  # input
  yrsel <- input$yrsel
  flsel <- input$flsel
  
  flnm <- paste0('sgdat', yrsel, 'simp')
  load(file = paste0('data/', flnm, '.RData'))
  
  tomap <- get(flnm) %>%
          filter(Category %in% flsel) %>%
          mutate(Category = fct_drop(Category))

  # fix colors based on selection
  colreg <- cols[levels(tomap$Category)]

  out <- mapview(tomap, homebutton = F, zcol = 'Category', layer.name = 'Category', col.regions = colreg, color = 'grey', lwd = 0) %>%
    .@map

  return(out)

})

# reactive edits module for map selection
edits <- reactive({

  # input
  allmap <- allmap()

  # this modifies available options in map selection toolber
  tomap <- allmap %>%
    addDrawToolbar(
      polylineOptions = FALSE,
      circleOptions = FALSE,
      circleMarkerOptions = FALSE,
      markerOptions = FALSE,
      editOptions = editToolbarOptions()#,
      # singleFeature = TRUE
    )

  out <- callModule(editMod, 'editor', tomap)

  return(out)

})

# selection from map as sf object, same crs as biodat
crpsel <- reactive({

  # input
  fltallsg <- fltallsg()
  edits <- edits()()

  # requires edits to continue
  validate(
    need(!is.null(edits$finished), 'Make a selection from the map using the draw features')
  )

  # get selection, calculate area
  tocrp <- edits$finished

  # check area of selection and validate
  chkarea <- st_area(tocrp) %>%
    set_units('acres') %>%
    as.numeric %>% 
    round(2)

  validate(
    need(chkarea > 1, paste0('Selected size is ', chkarea, ' acres and must be greater than 1 acre, please select a larger area'))
  )

  # crop and summarize by year
  out <- fltallsg %>%
    mutate(
      data = purrr::map(data, function(x){

        x <- st_intersection(tocrp, x) %>%
          mutate(
            area = st_area(.)
          ) 

        return(x)

      })
    )

  return(out)

})

# selection from map as sf object, same crs as biodat
mapsel <- reactive({

  # input
  crpsel <- crpsel()

  # crop and summarize by year
  out <- crpsel %>% 
    mutate(
      data = purrr::map(data, function(x) st_set_geometry(x, NULL))
    ) %>% 
    unnest('data') %>%
    group_by(yr, Category) %>%
    summarise(Acres = sum(area)) %>%
    ungroup %>%
    mutate(Acres = set_units(Acres, 'acres'))

  req(nrow(out) > 0)

  return(out)

})

# change estimates from map selection 
chgmapsel <- reactive({
  
  # input
  crpsel <- crpsel()
  edits <- edits()()

  # requires edits to continue
  validate(
    need(!is.null(edits$finished), 'Make a selection from the map using the draw features')
  )

  # get selection, calculate area
  tocrp <- edits$finished

  # check area of selection and validate
  chkarea <- st_area(tocrp) %>%
    set_units('acres') %>%
    as.numeric %>% 
    round(2)

  validate(
    need(chkarea < 20000, paste0('Selected size is ', chkarea, ' acres and must be less than 20,000 acres, please select a smaller area'))
  )
  
  validate(
    need(chkarea > 1, paste0('Selected size is ', chkarea, ' acres and must be greater than 1 acre, please select a larger area'))
  )

  out <- chgfun(crpsel)
  
  return(out)
  
})

# table selection for download and reactable
seltab <- reactive({

  # input
  mapsel <- mapsel()

  out <- mapsel %>%
    mutate(Acres = as.numeric(Acres)) %>%
    spread(Category, Acres, fill = 0) %>%
    mutate(Total = `cont.` + patchy)

  return(out)

})

# formatted selection table as reactable
frmtab <- reactive({

  # input
  seltab <- seltab()

  out <- reactable(seltab,
    columns = list(
      yr = colDef(name = 'Year'),
      Total = colDef(name = 'Total (acres)')
    ),
    defaultColDef = colDef(
      footerStyle = list(fontWeight = "bold"),
      format = colFormat(digits = 0, separators = TRUE),
      resizable = TRUE
    ),
   filterable = T,
   defaultPageSize = 15
  )

  return(out)

})

# plot selection
selplo <- reactive({

  # input
  mapsel <- mapsel()

  toplo <- mapsel %>%
    mutate(
      Acres = as.numeric(Acres)
    )

  p <- plot_ly(toplo, x = ~yr, y= ~Acres, color = ~Category, text = ~paste0(yr, ', ', Category, ', ', round(Acres, 0), ' acres'),
               hoverinfo = 'text',  colors = cols, alpha = 0.7) %>%
    add_bars() %>%
    layout(
      yaxis = list(title = 'Acres', gridcolor = '#ECECEC'),
      xaxis = list(title = ''),
      legend = list(x = 0, y = 1.1),
      barmode = 'stack',
      showlegend = T,
      font = list(family = fml),
      plot_bgcolor = '#FFFFFF'
    )
  #
  # p <- ggplot(toplo, aes(x = factor(yr), y = Acres, fill = Category)) +
  #   geom_bar(stat = 'identity') +
  #   scale_fill_manual(values = c('green', 'darkgreen')) +
  #   theme_minimal() +
  #   theme(
  #     axis.title.x = element_blank()
  #   )

  return(p)

})

# change plot selection
chgselplo <- reactive({
  
  # inputs
  chgmapsel <- chgmapsel()
  nodpd1 <- input$nodpd1
  
  out <- sanplofun(chgmapsel, nodpd1)
  
  return(out)
  
})

# fluccs change data by segment
chgseg <- reactive({

  snkseg <- input$snkseg
  flsel2 <- input$flsel2
  
  req(!is.null(flsel2))
  
  # regex for filter
  fltval <- paste0('^', flsel2) %>% 
    gsub('\\.', '\\\\.', .) %>% 
    paste(., collapse = '|')
  
  # filter by segment and fluccs
  out <- chgdat %>%
    filter(bay_segment %in% !!snkseg) %>% 
    filter(grepl(fltval, source)) %>% 
    filter(grepl(fltval, target))  
  
  return(out)
  
})

# fluccs change table by segment
chgsegtab <- reactive({
  
  # input
  chgseg <- chgseg()
  
  out <- chgseg %>% 
    select(-bay_segment) %>% 
    mutate(
      source_yr = as.numeric(gsub('^.*\\,\\s([0-9]+)$', '\\1', source)),
      target_yr = as.numeric(gsub('^.*\\,\\s([0-9]+)$', '\\1', target)), 
      source = gsub('\\,\\s[0-9]+$', '', source), 
      target = gsub('\\,\\s[0-9]+$', '', target)
    ) %>% 
    spread(target, value, fill = 0) %>% 
    rename(
      Category = source, 
      `Start year` = source_yr, 
      `End year` = target_yr
    )
  
  return(out)
  
})

# fluccs change table by segment, reactable
chgsegrcttab <- reactive({
  
  # input
  chgsegtab <- chgsegtab()
  
  out <- reactable(chgsegtab,
    columns = list(
      `Start year` = colDef(format = colFormat(separators = F)),
      `End year` = colDef(format = colFormat(separators = F))
    ),
    defaultColDef = colDef(
      footerStyle = list(fontWeight = "bold"),
      format = colFormat(digits = 0, separators = TRUE),
      resizable = TRUE
    ),
   filterable = T,
   defaultPageSize = 15
  )
  
  return(out)
  
})

# sankey flow chart by segment
chgsegplo <- reactive({
  
  # input
  chgseg <- chgseg()
  nodpd2 <- input$nodpd2
  
  out <- sanplofun(chgseg, nodpd2)  
  
  return(out)
  
})
```

```{r downloadhandlers}
# selected data
output$seldl <- downloadHandler(
  filename = function(){'seagrass_selection.csv'},
  content = function(file){
    
    # inputs
    seltab <- seltab()
    
    write.csv(seltab, file, quote = T, row.names = F)
    
  }
)

# selected segment data
output$selsegdl <- downloadHandler(
  filename = function(){'segment_selection.csv'},
  content = function(file){
    
    # inputs
    chgsegtab <- chgsegtab()
    
    write.csv(chgsegtab, file, quote = T, row.names = F)
    
  }
)
```

MAP SUMMARY
===========================================================

Column {data-width=250}
-----------------------------------------------------------------------

```{r}
# selection editor
editModUI('editor') %>% withSpinner()
```

Column {.tabset .tabset-fade}
-----------------------------------------------------------------------

```{r}
column(12,
  br(),
  # wellPanel(style = "overflow-y:scroll; max-height: 200px; background-color:#F2F2F2",
  column(4,
    selectInput('yrsel', 'Select year on map:', choices = allsg$yr, selected = '2018')
    ),
  column(4,
    selectInput('flsel', 'Select categories:', choices = flcat$name, selected = flcat$name, multiple = T)
    ),
  column(4, numericInput('nodpd1', 'Change spacing:', min = 0, max = 300, step = 10, value = 100))
  # )
)
```

### BARPLOT

```{r}
output$selplo <- renderPlotly(selplo())
plotlyOutput('selplo')
```

### TABULAR

```{r}
output$frmtab <- renderReactable(frmtab())
fillCol(flex = c(NA, 1),
  renderUI({
    req(!is.null(edits()()$finished))
    downloadBttn('seldl', 'Download data', style = 'simple', block = T, color = 'success')
  }),
  reactableOutput('frmtab')
)
```

### CHANGE PLOT

```{r}
output$chgselplo <- renderSankeyNetwork(chgselplo())
sankeyNetworkOutput('chgselplo')
```

CHANGE BY SEGMENT
===========================================================

Column {.tabset .tabset-fade}
-----------------------------------------------------------------------

### ALL YEARS

```{r}
output$chgsegplo <- renderSankeyNetwork(chgsegplo())
output$chgsegrcttab <- renderReactable(chgsegrcttab())
fillCol(flex = c(NA, 1),
  column(12, 
    column(3, selectInput('snkseg', 'Choose bay segment:', choices = list('Old Tampa Bay' = 'OTB', 'Hillsborough Bay' = 'HB', 'Middle Tampa Bay' = 'MTB', 'Lower Tampa Bay' = 'LTB'))), 
    column(3, selectInput('segres', 'Choose summary output:', choices = c('plot', 'table'))),
    column(3, selectInput('flsel2', 'Select categories:', choices = c(flcat$name, 'other'), selected = c(flcat$name, 'other'), multiple = T)), 
    column(3, numericInput('nodpd2', 'Change spacing (plot only):', min = 0, max = 300, step = 10, value = 100))
    ),
  renderUI({
    
    # input
    segres <- input$segres
    
    if(segres == 'plot')
      return(sankeyNetworkOutput('chgsegplo'))
    
    if(segres == 'table'){
      out <- fillCol(flex = c(NA, 1),
        downloadBttn('selsegdl', 'Download data', style = 'simple', block = T, color = 'success'),
        reactableOutput('chgsegrcttab')
      )
      return(out)
    }
    
  })
)
```

### YEAR VS YEAR